// 视频剪辑 - 使用 Worker 线程
import { resolveWorkerPath } from './utils/pathResolver';
ipcMain.handle('trim-video-start', async (_, { mode, input, output, start, end }) => {
  const jobId = Date.now().toString();

  return new Promise<{
    success: boolean;
    output?: string;
    error?: string;
  }>(resolve => {
    // @ts-ignore - Worker 类型不匹配 Electron Worker
    const worker = new Worker(resolveWorkerPath('videoWorker.js')) as any;
    activeWorkers.set(jobId, worker);

    worker.on('message', (data: any) => {
      if (data.type === 'progress') {
        if (mainWindow) {
          mainWindow.webContents.send('trim-progress', {
            percent: data.percent,
            mode,
          });
        }
      } else if (data.type === 'complete') {
        activeWorkers.delete(jobId);
        worker.terminate();

        if (mainWindow) {
          mainWindow.webContents.send('trim-complete', data);
        }
        resolve(data);
      }
    });

    worker.on('error', (err: any) => {
      activeWorkers.delete(jobId);
      const errorData = { success: false, error: (err as Error).message };
      if (mainWindow) {
        mainWindow.webContents.send('trim-complete', errorData);
      }
      resolve(errorData);
    });

    worker.postMessage({ mode, input, output, start, end });
  });
});
